import React, { useState, useEffect } from 'react';
import './App.css'; // Не забудь створити стилі (див. нижче)

// Функція для створення чистого поля
const createEmptyBoard = () => {
  const board = [];
  for (let y = 0; y < 10; y++) {
    const row = [];
    for (let x = 0; x < 10; x++) {
      row.push({ x, y, hasShip: false, isHit: false });
    }
    board.push(row);
  }
  return board;
};

// Функція для рандомної розстановки кораблів (спрощена)
const placeShipsRandomly = (board) => {
  // Робимо глибоку копію, щоб не мутувати вхідні дані
  const newBoard = board.map(row => row.map(cell => ({ ...cell })));
  
  // Просто ставимо 5 випадкових кораблів для прикладу
  let shipsPlaced = 0;
  while (shipsPlaced < 5) {
    const y = Math.floor(Math.random() * 10);
    const x = Math.floor(Math.random() * 10);
    
    if (!newBoard[y][x].hasShip) {
      newBoard[y][x].hasShip = true;
      shipsPlaced++;
    }
  }
  return newBoard;
};

function App() {
  // СТЕЙТ: Саме поле гри
  const [board, setBoard] = useState(createEmptyBoard());
  // СТЕЙТ: Лічильник ходів
  const [shots, setShots] = useState(0);
  // СТЕЙТ: Повідомлення про перемогу
  const [gameOver, setGameOver] = useState(false);

  // useEffect (аналог componentDidMount) - запускається один раз при старті
  useEffect(() => {
    const initialBoard = createEmptyBoard();
    const boardWithShips = placeShipsRandomly(initialBoard);
    setBoard(boardWithShips);
  }, []);

  // Логіка пострілу
  const handleShoot = (y, x) => {
    if (gameOver) return; // Гра закінчена, не можна клікати
    
    // 1. Беремо поточний борд
    const currentCell = board[y][x];

    // 2. Якщо вже стріляли — ігноруємо
    if (currentCell.isHit) return;

    // 3. !ВАЖЛИВО! Робимо КОПІЮ борду (React Way)
    // Ми не можемо просто написати board[y][x].isHit = true
    const newBoard = board.map(row => 
      row.map(cell => {
        if (cell.y === y && cell.x === x) {
          return { ...cell, isHit: true }; // Повертаємо оновлену клітинку
        }
        return cell; // Повертаємо стару клітинку
      })
    );

    // 4. Оновлюємо стейт
    setBoard(newBoard);
    setShots(shots + 1);

    // 5. Перевірка на влучання
    if (newBoard[y][x].hasShip) {
      console.log("Влучив!");
      checkWinCondition(newBoard);
    } else {
      console.log("Промах!");
    }
  };

  const checkWinCondition = (currentBoard) => {
    // Перевіряємо, чи залишились кораблі
    // flat() перетворює [[],[]] в []
    const hasShipsLeft = currentBoard.flat().some(cell => cell.hasShip && !cell.isHit);
    
    if (!hasShipsLeft) {
      setGameOver(true);
      alert(`Перемога! Ти впорався за ${shots + 1} пострілів.`);
    }
  };

  const restartGame = () => {
    const newBoard = placeShipsRandomly(createEmptyBoard());
    setBoard(newBoard);
    setShots(0);
    setGameOver(false);
  };

  return (
    <div className="game-container">
      <h1>Морський Бій (React)</h1>
      <p>Пострілів: {shots}</p>
      
      <div className="board">
        {/* Рендеримо рядки */}
        {board.map((row, y) => (
          <div key={y} className="row">
            {/* Рендеримо клітинки */}
            {row.map((cell, x) => (
              <div 
                key={`${y}-${x}`} 
                className={`cell 
                  ${cell.isHit && cell.hasShip ? 'hit' : ''} 
                  ${cell.isHit && !cell.hasShip ? 'miss' : ''}
                `}
                onClick={() => handleShoot(y, x)}
              >
                {cell.isHit && cell.hasShip && "❌"}
                {cell.isHit && !cell.hasShip && "•"}
              </div>
            ))}
          </div>
        ))}
      </div>

      {gameOver && <button onClick={restartGame}>Грати знову</button>}
    </div>
  );
}

export default App;
